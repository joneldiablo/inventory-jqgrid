/*
 *  inventory - v4.1.0
 *  A jump-start for jQuery plugins development.
 *  
 *
 *  Made by JD-R2
 *  Under MIT License
 */
!function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend(!0,{},m,{jqgrid:{ondblClickRow:h,onSelectRow:g,serializeGridData:k,loadError:j,beforeProcessing:i}},c),this._defaults=m,this._name=l,this.init()}function f(a){return a.replace(/-([a-z])/gi,function(a,b){return b.toUpperCase()})}function g(b,c,d){var e=a(this),f=e.jqGrid("getGridParam","savedRow");f.length>0&&f[0].id!==b&&e.jqGrid("restoreRow",f[0].id)}function h(b,c,d,e){a(this).jqGrid("editRow",b,{focusField:e.target})}function i(b){b.recordsFiltered=parseInt(b.recordsFiltered);var c=b.recordsFiltered/a(this).getGridParam("rowNum");b.total=Math.ceil(c)}function j(a,b,c){console.log(b),console.log(a)}function k(b){var c=a("#branchesFilter").find("option:selected").val(),d=a("#productsFilter").val();return a.extend(b,{columns:[{data:"branchName"},{data:"productName"},{data:"stockQuantity"},{data:"minQuantity"},{data:"maxQuantity"},{data:"cost"},{data:"publicPrice"}],start:(b.draw-1)*b.length,search:{},target1:c?c:"",target2:d,target3:""}),JSON.stringify(b)}var l="inventory",m={advancedSearch:!1,title:"Listado del Inventario",jqgrid:{url:"./ajaxinventorylist",loadonce:!1,colNames:["","","Sucursal","","Producto","Existencia","Mínimo","Máximo","Costo","Precio",""],colModel:[{name:"id",editable:!1,sortable:!1,hidden:!0},{name:"branchId",editable:!1,sortable:!1,hidden:!0},{name:"branchName",align:"left",editable:!1,sorttype:latinize,stype:"text",width:150,searchoptions:{sopt:["eq","ne","bw","bn","ew","en","cn","nc","nu","nn","in","ni"]}},{name:"productId",editable:!1,sortable:!1,hidden:!0},{name:"productName",align:"left",editable:!1,sorttype:latinize,stype:"text",width:150,searchoptions:{sopt:["eq","ne","bw","bn","ew","en","cn","nc","nu","nn","in","ni"]}},{name:"stockQuantity",template:"number",editable:!0,width:90,autoResizing:{minColWidth:50,resetWidthOrg:!1,compact:!1,fixWidthOnShrink:!0}},{name:"minQuantity",template:"number",editable:!0,width:90,autoResizing:{minColWidth:50,resetWidthOrg:!1,compact:!1,fixWidthOnShrink:!0}},{name:"maxQuantity",template:"number",editable:!0,width:90,autoResizing:{minColWidth:50,resetWidthOrg:!1,compact:!1,fixWidthOnShrink:!0}},{name:"cost",formatter:"currency",editable:!0,align:"right",width:90,autoResizing:{minColWidth:50,resetWidthOrg:!1,compact:!1,fixWidthOnShrink:!0},formatoptions:{decimalSeparator:".",thousandsSeparator:",",decimalPlaces:2,prefix:"$ "},searchoptions:{sopt:["eq","ne","lt","le","gt","ge"]}},{name:"publicPrice",formatter:"currency",editable:!0,align:"right",width:90,autoResizing:{minColWidth:50,resetWidthOrg:!1,compact:!1,fixWidthOnShrink:!0},formatoptions:{decimalSeparator:".",thousandsSeparator:",",decimalPlaces:2,prefix:"$ "},searchoptions:{sopt:["eq","ne","lt","le","gt","ge"]}},{name:"act",template:"actions",width:80,formatoptions:{delbutton:!1}}],datatype:"json",hidegrid:!1,navOptions:{reloadGridOptions:{fromServer:!0}},altRows:!0,autowidth:!0,shrinkToFit:!1,viewrecords:!0,loadui:!0,autoresizeOnLoad:!1,cmTemplate:{sortable:!1,autoResizable:!0,editable:!0},guiStyle:"bootstrap",iconSet:"fontAwesome",rowNum:10,autoResizing:{compact:!1},rowList:[10,20,50],autoencode:!0,sortable:!0,pager:!0,inlineEditing:{keys:!0,defaultFocusField:"origen",focusField:"origen"},rownumbers:!1,caption:"",grouping:!1,groupingView:{groupField:["sucursal"],groupColumnShow:[!0],groupText:[""],groupOrder:["asc"],groupSummary:[!1],groupSummaryPos:["header"],groupCollapse:!0},prmNames:{page:"draw",rows:"length"},jsonReader:{root:"data",page:"draw",records:"recordsFiltered"},ajaxGridOptions:{method:"POST",async:!0,contentType:"application/json",dataType:"json",mimeType:"application/json"}},branches:{url:"./ajaxBranchSimpleCatalogRequest",method:"POST",async:!0,contentType:"application/json",dataType:"json",mimeType:"application/json",data:'{ "catalogName":"Cat_Branch","language": "es" }'}};a.extend(e.prototype,{init:function(){var c=this,d=a("<div>",{class:"card-box inventory"}),e=a("<h4>",{class:"header-title m-t-0 m-b-30"}).text(c.settings.title),f=a("<div>",{class:"row"}),g=a("<div>",{class:"form-group col-sm-4"}),h=a("<label>",{for:"branchesFilter",class:"control-label btn-block"}).text("Sucursales"),i=a("<select>",{class:"form-control",id:"branchesFilter"}),j=g.clone(),k=a("<label>",{for:"productsFilter",class:"control-label"}).text("Producto"),l=a("<input>",{type:"text",class:"form-control",id:"productsFilter"}),m=a("<div>",{class:"form-group col-sm-1"}),n=a("<button>",{type:"button",class:"form-control btn btn-danger disabled",id:"clearFilter",title:"Limpiar filtros",disabled:"disabled",css:{marginTop:25}}).html("<i class='fa fa-filter-remove'></i>").click(function(){c.filterClear()}),o=a("<table>");d.append(e,f,o),f.append(g,j,m),g.append(h,i),j.append(k,l),m.append(n),a(c.element).append(d),c.$grid=o,c.$selectBranchesFilter=i,c.$inputProductsFilter=l,c.$inputClearFilter=n,a.ajax(c.settings.branches).done(function(b){if(void 0===b.Cat_Branch)return void a(c.element).trigger("inventory.branchesError",b);i.append(a("<option>",{value:0}).text("Todas")),a.each(b.Cat_Branch,function(b,c){var d=a("<option>",{value:c.id}).text(c.value);i.append(d)})}),o.jqGrid(c.settings.jqgrid).jqGrid("gridResize").jqGrid("bindKeys").jqGrid("navGrid",{edit:!1,add:!1,del:!1,search:c.settings.advancedSearch,refresh:!0},{},{},{},{closeAfterSearch:!0,multipleSearch:!0,multipleGroup:!0}),l.on("keyup",function(){return c.keyupDelay||(c.keyupDelay=setTimeout(function(){var a=l.val();c.filterByProducts(a),c.keyupDelay=!1},1e3)),!1}),i.on("change",function(b){var d=a(this),e=d.find("option:selected").text();return c.filterByBranches(e),!1}),a(".ui-jqgrid-title").click(function(){a(this).parent().find(".ui-jqgrid-titlebar-close").click()}),a(".ui-jqgrid-titlebar-close, .ui-pg-button").click(function(){setTimeout(function(){a(b).resize()},200)}),o.on("jqGridInlineAfterSaveRow",function(b,d){var e=o.jqGrid("getRowData",d);a(c.element).trigger("inventory.saveRow",e)}),o.on("jqGridInlineEditRow",function(b,c,d){a("#"+c).find("input, select").addClass("form-control")}),a(b).resize(function(){c.resizeDelay||(c.resizeDelay=setTimeout(function(){var a=o.closest(".ui-jqgrid").parent().width();a>610?o.jqGrid("getGridParam","shrinkToFit")||o.jqGrid("setGridParam",{shrinkToFit:!0}):o.jqGrid("getGridParam","shrinkToFit")&&o.jqGrid("setGridParam",{shrinkToFit:!1}),o.jqGrid("setGridWidth",a),c.resizeDelay=!1},500))}).trigger("resize"),o.on("jqGridFilterBeforeShow",function(a,b){b.closest(".ui-jqdialog").addClass("inventory")}),o.on("jqGridFilterReset",function(a){}),o.on("jqGridBeforeRequest",function(){c.$grid.jqGrid("getGridParam","search")||c.filterDomClear()})},filterGet:function(){var a,b=this.$grid.jqGrid("getGridParam","postData");try{a=JSON.parse(b.filters)}catch(c){return!1}return"object"!=typeof a.groups&&(a.groups=[]),a},filterObj:function(){return{groupOp:"AND",groups:[]}},filterSet:function(a){return this.$grid.jqGrid("getGridParam","postData").filters=JSON.stringify(a),this.$grid.jqGrid("setGridParam",{search:!0}),this.$grid.trigger("reloadGrid",[{page:1,current:!0}]),this.$inputClearFilter.removeClass("disabled").prop("disabled",!1),!0},filterClear:function(){return this.filterDomClear(),this.$grid.jqGrid("getGridParam","postData").filters="",this.$grid.jqGrid("setGridParam",{search:!1}),this.$grid.trigger("reloadGrid",[{page:1,current:!0}]),!0},filterDomClear:function(){this.$inputProductsFilter.val(""),this.$selectBranchesFilter.val(null).trigger("change"),this.$inputClearFilter.addClass("disabled").prop("disabled",!0)},filterByProducts:function(a){var b=this.filterGet();return b||(b=this.filterObj()),b.groups.filter(function(b){if("products"===b.criteria)return b.rules=[{field:"producto",op:"cn",data:a}],b}).length<1&&b.groups.push({criteria:"products",groupOp:"OR",rules:[{field:"producto",op:"cn",data:a}]}),this.filterSet(b),!0},filterRmProduct:function(){var a=this.filterGet();return!a||(a=a.groups.filter(function(a){if("products"!==a.criteria)return a}),this.filterSet(a),!0)},filterByBranches:function(a){var b=this.filterGet(),c=[];return b||(b=this.filterObj()),c.push({field:"sucursal",op:"eq",data:a}),b.groups.filter(function(a){if("branches"===a.criteria)return a.rules=c,a}).length<1&&b.groups.push({criteria:"branches",groupOp:"OR",rules:c}),this.filterSet(b),!0},filterRmBranches:function(){var a=this.filterGet();return!a||(a=a.groups.filter(function(a){if("branches"!==a.criteria)return a}),this.filterSet(a),!0)},help:function(){var b=a.map(this,function(a,b){if("function"==typeof a)return b});return console.log("defaults"),console.log(m),console.log("métodos disponibles"),console.log(b),console.log("------------"),[JSON.stringify(m),JSON.stringify(b)]}}),a.fn[l]=function(b,c){var d;if("string"!=typeof b)c=b,d=this.each(function(b,d){a.data(d,"plugin_"+l)||a.data(d,"plugin_"+l,new e(d,c))});else switch(d=this.map(function(d,g){var h,i=a.data(g,"plugin_"+l);return i||(i=new e(g,c),a.data(g,"plugin_"+l,i)),"function"==typeof i[f(b)]&&(h=i[f(b)](c)),h}).get(),d.length){case 0:d=null;break;case 1:d=d[0]}return d}}(jQuery,window,document);